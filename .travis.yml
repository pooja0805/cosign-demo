os: linux
arch: ppc64le
dist: focal
language: shell

# keys:
#   - SSH_KEY_FOR_SIGNING # must match the key identifier set in the UI
  
env:
  global:
    secure: N1BRFPO8FEagreOFMdca8NqF+WWC3LlGIPXbQPAzuNR9O67+2jEs6LNmceCez2kvR/WXbEh9hjzRzPlHT9zgLVTg4iI9lnhmdC7Nn9v/xVni3Sh3p4LwYqAiA7A89GrcWr4jsecEV5/tRu7T7huKQm0Lqk7mPstChYTAtVdcEl8LlFi6gU7rauCKICSKCmQjWvQ7c1SHiLANryZWmBuaNY3wWsMt0ownVonRlhWrbduMh3FndhQtTrzvtm9tWgtMYgHB/89jlLfJymmSJ8JTDvWAFISSHvL2AiATHbk0jTbnsp1woOY+G8mG0+AUa6EgCv6YdVm4iMcdx2Ck2JMhxz+2E/9Z1SseLSeVnHcF+rQxVZyYa7WlJS8w65s85QcWO7ZZuixclTc38m39GgtzvIUG6ou5n8984XKvdeAi+OSV4q1v/ktkIq6vOgUtEeddlnUxtBr52C3CCiO/SwDOCwYNjBrvfSTHMOz7FoK0vaBZkdxejax0PRYYc90svlzaz9H04mQNhUEvqSukcWE4GAMnbX2M7+Htt37ljUshtEazxLkCZAChIWgJPW9CMHqs+Dbg705YRoXBKnOPsSrm7ZuvexTJHXJB5htOgzsIp6m/EEtaqZBxmWIaV1vCDmrzlZBav8p3/N96/R9f3MmAIGZdzLz2Hcd7nZcQTcvrSwE=

# before_script: 
#   - travis_key SSH_KEY_FOR_SIGNING cosign.key  # cosign requires the key to be in a file
  
script: 
  - sudo apt-get update && sudo apt-get install -y curl python3-dev python3 python3-pip python3-cffi python3-lxml apt-transport-https ca-certificates curl gnupg lsb-release iptables dbus-user-session libseccomp2
  # - wget -O docker-compose https://github.com/docker/compose/releases/download/v2.24.2/docker-compose-linux-ppc64le
  # - sudo cp docker-compose /usr/bin/docker-compose
  # - sudo chmod +x /usr/bin/docker-compose
  # - ls /usr/bin/ | grep docker
  - DOCKER_VERSION=24.0.9
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg && \
    echo "deb [arch=ppc64el signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu  $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null && \
    sudo apt-get update -y && \
    sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin docker-buildx-plugin
  - sudo dockerd & 
  - sleep 60
  - sudo docker version | grep $DOCKER_VERSION 
  - sudo usermod -aG docker $USER
  - docker ps -a
  - git clone https://github.com/quay/clair.git && cd clair && git checkout v4.7.2 && sudo docker compose up -d
  - #Install Clairctl
  - wget https://github.com/quay/clair/releases/download/v4.7.2/clairctl-linux-ppc64le
  - wget https://raw.githubusercontent.com/quay/clair/main/local-dev/clair/config.yaml
  - sudo cp clairctl-linux-ppc64le /usr/bin/clairctl
  - sudo chmod +x /usr/bin/clairctl
  - ls /usr/bin/ | grep clair
  - sudo clairctl -c ./config.yaml report --host "http://localhost:6060/" -o json nginx:latest > clair-results.json
  - cat clair-results.json
